<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Two-Step Equations Practice â€“ Mr. McLean Math</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --bg: #f5f5f5;
      --bg-alt: #ffffff;
      --text: #222222;
      --accent: #1976d2;
      --accent-soft: #e3f2fd;
      --correct: #2e7d32;
      --incorrect: #c62828;
      --border: #cccccc;
      --panel: #fafafa;
    }

    body.high-contrast {
      --bg: #000000;
      --bg-alt: #111111;
      --text: #ffffff;
      --accent: #ffcc00;
      --accent-soft: #333333;
      --correct: #00e676;
      --incorrect: #ff5252;
      --border: #666666;
      --panel: #222222;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px;
    }

    h1 {
      text-align: center;
      margin-bottom: 8px;
      font-size: 2rem;
    }

    h2 {
      margin-top: 0;
    }

    .subheading {
      text-align: center;
      margin-bottom: 20px;
      font-size: 0.95rem;
      opacity: 0.8;
    }

    .top-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
      margin-bottom: 16px;
    }

    .mode-toggle,
    .difficulty-toggle,
    .timer-controls,
    .toggles-group {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .mode-btn,
    .difficulty-btn,
    .small-btn {
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 6px 12px;
      background: var(--bg-alt);
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.15s, transform 0.05s, border-color 0.15s;
    }

    .mode-btn.active,
    .difficulty-btn.active {
      background: var(--accent-soft);
      border-color: var(--accent);
      font-weight: 600;
    }

    .mode-btn:hover,
    .difficulty-btn:hover,
    .small-btn:hover {
      transform: translateY(-1px);
    }

    .toggle-label {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 0.85rem;
      cursor: pointer;
      user-select: none;
    }

    .toggle-label input {
      cursor: pointer;
    }

    .main-grid {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.2fr);
      gap: 16px;
      align-items: flex-start;
    }

    @media (max-width: 900px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: var(--bg-alt);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.06);
      border: 1px solid var(--border);
    }

    .equation-display {
      min-height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      text-align: center;
      padding: 12px;
      border-radius: 8px;
      background: var(--panel);
      margin-bottom: 16px;
    }

    .equation-display .variable {
      font-weight: 700;
    }

    .fraction {
      display: inline-block;
      text-align: center;
      vertical-align: middle;
      margin: 0 2px;
    }

    .fraction .numerator {
      display: block;
      padding: 0 3px;
    }

    .fraction .denominator {
      display: block;
      padding: 0 3px;
      border-top: 2px solid var(--text);
    }

    .input-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
    }

    .input-row label {
      font-size: 1rem;
      font-weight: 500;
    }

    .answer-input {
      font-size: 1.4rem;
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      min-width: 120px;
      max-width: 180px;
    }

    .answer-input:focus {
      outline: 2px solid var(--accent);
      outline-offset: 1px;
    }

    .primary-btn,
    .secondary-btn {
      font-size: 1rem;
      padding: 8px 18px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      transition: background 0.15s, transform 0.05s;
    }

    .primary-btn {
      background: var(--accent);
      color: #ffffff;
    }

    .primary-btn:hover {
      transform: translateY(-1px);
    }

    .primary-btn:disabled {
      opacity: 0.5;
      cursor: default;
      transform: none;
    }

    .secondary-btn {
      background: var(--panel);
      border: 1px solid var(--border);
    }

    .secondary-btn:hover {
      transform: translateY(-1px);
    }

    .feedback {
      margin-top: 8px;
      min-height: 40px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 1rem;
    }

    .feedback.correct {
      color: var(--correct);
    }

    .feedback.incorrect {
      color: var(--incorrect);
    }

    .steps {
      margin-top: 8px;
      padding: 8px;
      background: var(--panel);
      border-radius: 8px;
      font-size: 0.95rem;
      max-height: 220px;
      overflow-y: auto;
    }

    .steps-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .timer-display {
      font-size: 0.9rem;
      padding: 4px 8px;
      border-radius: 999px;
      background: var(--panel);
      min-width: 70px;
      text-align: center;
    }

    .summary-item {
      font-size: 0.9rem;
      margin-bottom: 4px;
    }

    .summary-stat {
      font-weight: 600;
    }

    .incorrect-list {
      margin-top: 8px;
      font-size: 0.85rem;
      max-height: 200px;
      overflow-y: auto;
      border-top: 1px solid var(--border);
      padding-top: 6px;
    }

    .incorrect-item {
      margin-bottom: 6px;
    }

    .tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--panel);
      font-size: 0.75rem;
      margin-left: 4px;
    }

    .footer {
      text-align: center;
      margin-top: 24px;
      font-size: 0.85rem;
      opacity: 0.8;
    }

    .mode-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    .worksheet-controls {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    select {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--bg-alt);
      font-size: 0.9rem;
    }

    .worksheet-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.6fr) minmax(0, 1fr);
      gap: 16px;
    }

    @media (max-width: 900px) {
      .worksheet-grid {
        grid-template-columns: 1fr;
      }
    }

    .worksheet-block {
      background: var(--panel);
      border-radius: 8px;
      padding: 10px;
      font-size: 0.95rem;
      max-height: 430px;
      overflow-y: auto;
    }

    .worksheet-title {
      font-weight: 600;
      margin-bottom: 6px;
    }

    .worksheet-question {
      margin-bottom: 16px;
    }

    .answer-key-item {
      margin-bottom: 6px;
    }

    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--bg-alt);
      font-size: 0.8rem;
    }

    .dev-panel {
      margin-top: 16px;
      padding: 8px;
      border-radius: 8px;
      border: 1px dashed var(--border);
      font-size: 0.8rem;
      background: var(--panel);
      display: none;
    }

    .dev-panel.visible {
      display: block;
    }

    .dev-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
    }

    .dev-log {
      max-height: 140px;
      overflow-y: auto;
      background: var(--bg-alt);
      border-radius: 6px;
      padding: 6px;
      border: 1px solid var(--border);
      white-space: pre-wrap;
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0,0,0,0);
      border: 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Two-Step Equations Practice</h1>
    <div class="subheading">Solve for x, y, or k. Free input, three difficulty levels, and worksheet generator.</div>

    <div class="top-bar" aria-label="Main controls">
      <div class="mode-toggle" role="radiogroup" aria-label="Mode">
        <button class="mode-btn active" data-mode="game" aria-pressed="true">ðŸŽ® Game mode</button>
        <button class="mode-btn" data-mode="worksheet" aria-pressed="false">ðŸ“„ Worksheet mode</button>
      </div>

      <div class="difficulty-toggle" role="radiogroup" aria-label="Difficulty">
        <span>Difficulty:</span>
        <button class="difficulty-btn active" data-diff="easy" aria-pressed="true">ðŸŸ¢ Easy</button>
        <button class="difficulty-btn" data-diff="medium" aria-pressed="false">ðŸŸ¡ Medium</button>
        <button class="difficulty-btn" data-diff="hard" aria-pressed="false">ðŸ”´ Hard</button>
        <button class="difficulty-btn" data-diff="random" aria-pressed="false">ðŸŽ² Random</button>
      </div>

      <div class="timer-controls">
        <label class="toggle-label">
          <input type="checkbox" id="timer-toggle">
          Timer
        </label>
        <select id="timer-select" aria-label="Timer duration">
          <option value="30">30s</option>
          <option value="60">60s</option>
          <option value="90">90s</option>
          <option value="120">120s</option>
        </select>
        <div class="timer-display" id="timer-display">Timer off</div>
      </div>

      <div class="toggles-group">
        <label class="toggle-label">
          <input type="checkbox" id="sound-toggle" checked>
          Sound
        </label>
        <label class="toggle-label">
          <input type="checkbox" id="contrast-toggle">
          High contrast
        </label>
      </div>
    </div>

    <div id="game-section">
      <div class="main-grid">
        <div class="card" aria-label="Problem and answer area">
          <div class="equation-display" id="equation-display">
            Press "New Question" to begin.
          </div>

          <div class="input-row">
            <label id="answer-label" for="answer-input">Your answer:</label>
            <input id="answer-input" class="answer-input" type="text" autocomplete="off">
            <button id="submit-btn" class="primary-btn">Submit</button>
            <button id="next-btn" class="secondary-btn" disabled>Next</button>
          </div>
          <div class="input-row" style="font-size:0.85rem; opacity:0.8;">
            <span>Tip: Use <span class="pill">,</span> or <span class="pill">.</span> for decimals. Press <span class="pill">Enter</span> to submit, <span class="pill">Esc</span> to clear.</span>
          </div>

          <div id="feedback" class="feedback" aria-live="polite"></div>
          <button id="show-steps-btn" class="small-btn" disabled>Show steps</button>
          <div id="steps" class="steps" style="display:none;">
            <div class="steps-title">Worked solution</div>
            <div id="steps-content"></div>
          </div>
        </div>

        <div class="card" aria-label="Session summary">
          <h2 style="font-size:1.1rem; margin-bottom:8px;">Session summary</h2>
          <div class="summary-item">Questions attempted: <span class="summary-stat" id="stat-attempted">0</span></div>
          <div class="summary-item">Correct: <span class="summary-stat" id="stat-correct">0</span></div>
          <div class="summary-item">Accuracy: <span class="summary-stat" id="stat-accuracy">0%</span></div>
          <div class="summary-item">Score: <span class="summary-stat" id="stat-score">0</span></div>
          <div class="summary-item">Current streak: <span class="summary-stat" id="stat-streak">0</span></div>
          <div class="summary-item">Best streak: <span class="summary-stat" id="stat-best-streak">0</span></div>

          <button id="toggle-incorrect-btn" class="small-btn" style="margin-top:8px;">Show incorrect questions</button>
          <div id="incorrect-list" class="incorrect-list" style="display:none;"></div>
        </div>
      </div>
    </div>

    <div id="worksheet-section" style="display:none;">
      <div class="card">
        <div class="mode-header">
          <h2 style="font-size:1.1rem;">Worksheet generator</h2>
          <div class="worksheet-controls">
            <label>Difficulty:
              <select id="ws-diff">
                <option value="easy">ðŸŸ¢ Easy</option>
                <option value="medium">ðŸŸ¡ Medium</option>
                <option value="hard">ðŸ”´ Hard</option>
                <option value="random">ðŸŽ² Random</option>
              </select>
            </label>
            <label>Questions:
              <select id="ws-count">
                <option value="5">5</option>
                <option value="10">10</option>
                <option value="15">15</option>
              </select>
            </label>
            <button id="ws-generate-btn" class="primary-btn">Generate worksheet</button>
          </div>
        </div>
        <div class="worksheet-grid">
          <div class="worksheet-block" aria-label="Worksheet questions">
            <div class="worksheet-title">Questions</div>
            <div style="font-size:0.85rem; margin-bottom:6px;">Instructions: Solve each equation. Show your working.</div>
            <div id="ws-questions"></div>
          </div>
          <div class="worksheet-block" aria-label="Answer key">
            <div class="worksheet-title">
              Answer key
              <span class="tag" id="ws-key-status">Hidden</span>
            </div>
            <div style="margin-bottom:6px;">
              <button id="ws-show-all" class="small-btn">Reveal all</button>
              <button id="ws-hide-all" class="small-btn">Hide all</button>
            </div>
            <div id="ws-answers"></div>
          </div>
        </div>
      </div>
    </div>

    <div id="dev-panel" class="dev-panel" aria-label="Developer tests">
      <div><strong>Developer tests (?dev=1)</strong></div>
      <div class="dev-buttons">
        <button class="small-btn" data-dev-test="easy100">Test 100 easy equations</button>
        <button class="small-btn" data-dev-test="medium100">Test 100 medium equations</button>
        <button class="small-btn" data-dev-test="hard100">Test 100 hard equations</button>
        <button class="small-btn" data-dev-test="negatives">Check for negative solutions</button>
        <button class="small-btn" data-dev-test="fractions">Check fraction rendering</button>
        <button class="small-btn" data-dev-test="decimals">Check decimal parsing</button>
        <button class="small-btn" data-dev-test="no-auto-advance">Check no auto-advance</button>
        <button class="small-btn" data-dev-test="streak">Check streak & score</button>
        <button class="small-btn" data-dev-test="worksheet">Check worksheet mapping</button>
        <button class="small-btn" data-dev-test="random-mix">Check random difficulty mix</button>
      </div>
      <div class="dev-log" id="dev-log"></div>
    </div>

    <div class="footer">
      Created by Mr. McLean Math.
    </div>
  </div>

  <script>
    // ----------- Number formatting -----------

    function formatNumber(num, decimalsAllowed) {
      const negative = num < 0;
      let value = Math.abs(num);

      let useDecimals = false;
      if (decimalsAllowed) {
        value = Math.round(value * 10) / 10;
        if (Math.abs(value - Math.round(value)) > 1e-9) {
          useDecimals = true;
        }
      } else {
        value = Math.round(value);
      }

      let intPart = useDecimals ? Math.floor(value).toString() : Math.round(value).toString();
      let decPart = "";
      if (useDecimals) {
        const raw = value.toFixed(1);
        decPart = raw.split(".")[1] || "";
      }

      let resultInt = "";
      for (let i = 0; i < intPart.length; i++) {
        const posFromRight = intPart.length - i - 1;
        resultInt += intPart[i];
        if (posFromRight > 0 && posFromRight % 3 === 0) {
          resultInt += " ";
        }
      }

      let finalStr = resultInt;
      if (useDecimals) {
        finalStr += "." + decPart;
      }

      if (negative) finalStr = "-" + finalStr;
      return finalStr;
    }

    // ----------- Helpers to avoid multiplying/dividing negatives in steps -----------

    function formatDivisionStep(variable, numerator, denominator, decimalsAllowed) {
      // show division with positive operands only; minus sign out front if needed
      const absNum = Math.abs(numerator);
      const numStr = formatNumber(absNum, decimalsAllowed);
      const denStr = formatNumber(Math.abs(denominator), decimalsAllowed);
      if (numerator < 0) {
        return variable + " = -" + numStr + " / " + denStr;
      } else {
        return variable + " = " + numStr + " / " + denStr;
      }
    }

    function formatMultiplicationStep(variable, factor, multiplier, decimalsAllowed) {
      // show multiplication with positive operands only; minus sign out front if needed
      const absFactor = Math.abs(factor);
      const factorStr = formatNumber(absFactor, decimalsAllowed);
      const multStr = formatNumber(Math.abs(multiplier), decimalsAllowed);
      if (factor < 0) {
        return variable + " = -" + factorStr + " Ã— " + multStr;
      } else {
        return variable + " = " + factorStr + " Ã— " + multStr;
      }
    }

    // ----------- Simple beep -----------

    let audioContext = null;
    let soundEnabled = true;

    function playBeep(frequency) {
      if (!soundEnabled) return;
      try {
        if (!audioContext) {
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }
        const duration = 0.12;
        const osc = audioContext.createOscillator();
        const gain = audioContext.createGain();
        osc.frequency.value = frequency;
        osc.type = "sine";
        gain.gain.setValueAtTime(0.12, audioContext.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
        osc.connect(gain);
        gain.connect(audioContext.destination);
        osc.start();
        osc.stop(audioContext.currentTime + duration);
      } catch (e) {}
    }

    // ----------- Random helpers -----------

    function randomChoice(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }

    function randomInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    // **Positive-only solutions**
    function randomSolutionInteger() {
      return randomInt(1, 20); // 1..20, no negatives, no zero
    }

    function randomSolutionDecimal() {
      const base = randomInt(1, 100); // 0.1 .. 10.0, positive
      return base / 10;
    }

    function wrapWithFractionHTML(numeratorHTML, denominatorHTML) {
      return '<span class="fraction"><span class="numerator">' + numeratorHTML +
        '</span><span class="denominator">' + denominatorHTML + "</span></span>";
    }

    function formatVariable(variable) {
      return variable;
    }

    function formatTermCoeffVar(a, variable, omitSignForPositive) {
      const absA = Math.abs(a);
      let coeffStr = "";
      if (absA === 1) {
        coeffStr = "";
      } else {
        coeffStr = formatNumber(absA, false);
      }
      if (omitSignForPositive) {
        return coeffStr + formatVariable(variable);
      }
      if (a < 0) {
        return "-" + coeffStr + formatVariable(variable);
      } else {
        return coeffStr + formatVariable(variable);
      }
    }

    function formatSignedConst(b) {
      if (b === 0) return "";
      if (b > 0) {
        return "+ " + formatNumber(b, false);
      } else {
        return "- " + formatNumber(Math.abs(b), false);
      }
    }

    // ----------- EASY -----------

    function generateEasyQuestion() {
      const variable = randomChoice(["x", "y", "k"]);
      const pattern = Math.random() < 0.5 ? "integer" : "fraction";

      if (pattern === "integer") {
        while (true) {
          const a = randomInt(1, 10);          // positive coefficient
          const sol = randomSolutionInteger(); // positive solution
          const b = randomInt(-40, 40);        // constant can be negative
          const c = a * sol + b;

          if (c <= 0 || Math.abs(c) > 120) continue;

          const termVar = formatTermCoeffVar(a, variable);
          const termConst = formatSignedConst(b);
          const leftExpr = termVar + (termConst ? " " + termConst : "");
          const rightExpr = formatNumber(c, false);
          const eqHtml = leftExpr + " = " + rightExpr;

          const steps = [];
          steps.push(eqHtml);
          const step2Right = c - b; // = a * sol > 0
          const signB = b >= 0 ? " - " + formatNumber(Math.abs(b), false)
                               : " + " + formatNumber(Math.abs(b), false);
          steps.push(formatTermCoeffVar(a, variable) + " = " + formatNumber(c, false) + signB);
          steps.push(formatTermCoeffVar(a, variable) + " = " + formatNumber(step2Right, false));
          steps.push(formatDivisionStep(variable, step2Right, a, false));
          steps.push(variable + " = " + formatNumber(sol, false));

          return {
            html: eqHtml,
            variable,
            solution: sol,
            stepsHtml: steps.join("<br>"),
            raw: { a, b, c, pattern: "easy-integer" }
          };
        }
      } else {
        while (true) {
          const n = randomChoice([2, 4, 5, 10]); // positive
          const k = randomInt(1, 20);           // positive
          const sol = k * n;                    // positive solution
          const b = randomInt(-30, 30);
          const c = sol / n + b;

          if (c <= 0 || Math.abs(c) > 120) continue;
          if (Math.abs(c - Math.round(c)) > 1e-9) continue;
          const cInt = Math.round(c);

          const frac = wrapWithFractionHTML(variable, n.toString());
          const termConst = formatSignedConst(b);
          const leftExpr = frac + (termConst ? " " + termConst : "");
          const rightExpr = formatNumber(cInt, false);
          const eqHtml = leftExpr + " = " + rightExpr;

          const steps = [];
          steps.push(eqHtml);

          const cMinusB = cInt - b; // = sol/n > 0
          const signB = b >= 0 ? " - " + formatNumber(Math.abs(b), false)
                               : " + " + formatNumber(Math.abs(b), false);
          steps.push(
            wrapWithFractionHTML(variable, n.toString()) +
            " = " + formatNumber(cInt, false) + signB
          );
          steps.push(
            wrapWithFractionHTML(variable, n.toString()) +
            " = " + formatNumber(cMinusB, false)
          );
          steps.push(formatMultiplicationStep(variable, cMinusB, n, false));
          steps.push(variable + " = " + formatNumber(sol, false));

          return {
            html: eqHtml,
            variable,
            solution: sol,
            stepsHtml: steps.join("<br>"),
            raw: { n, b, cInt, pattern: "easy-fraction" }
          };
        }
      }
    }

    // ----------- MEDIUM -----------

    function generateMediumQuestion() {
      const variable = randomChoice(["x", "y", "k"]);
      const pattern = Math.random() < 0.6 ? "like-terms" : "fraction";

      if (pattern === "like-terms") {
        const sol = randomSolutionInteger(); // positive
        let a1, a2, signSecond, combined;

        // ensure combined coefficient is positive (so division is by positive)
        do {
          a1 = randomInt(1, 6);
          a2 = randomInt(1, 6);
          signSecond = Math.random() < 0.5 ? 1 : -1;
          combined = a1 + signSecond * a2;
        } while (combined <= 0);

        let b = randomInt(-30, 30);
        let c = combined * sol + b; // RHS
        if (Math.abs(c) > 120) {
          return generateMediumQuestion();
        }

        const term1 = formatTermCoeffVar(a1, variable);
        const term2 = (signSecond === 1 ? " + " : " - ") +
          formatTermCoeffVar(a2, variable, true);
        const termConst = formatSignedConst(b);

        const leftExpr = term1 + term2 + " " + termConst;
        const rightExpr = formatNumber(c, false);
        const eqHtml = leftExpr + " = " + rightExpr;

        const steps = [];
        steps.push(eqHtml);

        const combinedTerm = formatTermCoeffVar(combined, variable);
        steps.push(combinedTerm + " " + formatSignedConst(b) + " = " + formatNumber(c, false));

        const cMinusB = c - b; // = combined * sol > 0
        const signB = b >= 0 ? " - " + formatNumber(Math.abs(b), false)
                             : " + " + formatNumber(Math.abs(b), false);
        steps.push(combinedTerm + " = " + formatNumber(c, false) + signB);
        steps.push(combinedTerm + " = " + formatNumber(cMinusB, false));
        steps.push(formatDivisionStep(variable, cMinusB, combined, false));
        steps.push(variable + " = " + formatNumber(sol, false));

        return {
          html: eqHtml,
          variable,
          solution: sol,
          stepsHtml: steps.join("<br>"),
          raw: { a1, a2, signSecond, b, c, combined, pattern: "medium-like-terms" }
        };

      } else {
        const n = randomChoice([2, 4, 5, 10]);
        const k = randomInt(1, 24);  // positive
        const sol = k * n;           // positive
        const b = randomInt(-40, 40);
        const c = sol / n + b;
        if (Math.abs(c) > 140) {
          return generateMediumQuestion();
        }
        if (Math.abs(c - Math.round(c)) > 1e-9) {
          return generateMediumQuestion();
        }
        const cInt = Math.round(c);

        const frac = wrapWithFractionHTML(variable, n.toString());
        const termConst = formatSignedConst(b);
        const leftExpr = frac + " " + termConst;
        const rightExpr = formatNumber(cInt, false);
        const eqHtml = leftExpr + " = " + rightExpr;

        const steps = [];
        steps.push(eqHtml);

        const cMinusB = cInt - b; // = sol/n > 0
        const signB = b >= 0 ? " - " + formatNumber(Math.abs(b), false)
                             : " + " + formatNumber(Math.abs(b), false);
        steps.push(
          wrapWithFractionHTML(variable, n.toString()) +
          " = " + formatNumber(cInt, false) + signB
        );
        steps.push(
          wrapWithFractionHTML(variable, n.toString()) +
          " = " + formatNumber(cMinusB, false)
        );
        steps.push(formatMultiplicationStep(variable, cMinusB, n, false));
        steps.push(variable + " = " + formatNumber(sol, false));

        return {
          html: eqHtml,
          variable,
          solution: sol,
          stepsHtml: steps.join("<br>"),
          raw: { n, b, cInt, pattern: "medium-fraction" }
        };
      }
    }

    // ----------- HARD -----------

    function generateHardQuestion() {
      const variable = randomChoice(["x", "y", "k"]);
      const patternRand = Math.random();
      let pattern;
      if (patternRand < 0.4) pattern = "multi-like-terms";
      else if (patternRand < 0.7) pattern = "fraction-decimal";
      else pattern = "decimal-coeff";

      if (pattern === "multi-like-terms") {
        const sol = Math.random() < 0.5 ? randomSolutionInteger() : randomSolutionDecimal(); // positive
        let a1 = randomInt(1, 4);
        let a2 = randomInt(1, 4);
        let a3 = randomInt(1, 4);
        const sumA = a1 + a2 + a3; // positive

        let b = randomInt(-40, 40);
        let c = sumA * sol + b;

        if (Math.abs(c) > 150) {
          return generateHardQuestion();
        }

        c = Math.round(c * 10) / 10;

        const coeff1 = formatTermCoeffVar(a1, variable);
        const coeff2 = " + " + formatTermCoeffVar(a2, variable, true);
        const coeff3 = " + " + formatTermCoeffVar(a3, variable, true);
        const termConst = formatSignedConst(b);

        const leftExpr = coeff1 + coeff2 + coeff3 + " " + termConst;
        const rightExpr = formatNumber(c, true);
        const eqHtml = leftExpr + " = " + rightExpr;

        const steps = [];
        steps.push(eqHtml);

        const combinedTerm = formatTermCoeffVar(sumA, variable);
        steps.push(combinedTerm + " " + formatSignedConst(b) + " = " + formatNumber(c, true));

        const cMinusB = c - b; // = sumA * sol > 0
        const signB = b >= 0 ? " - " + formatNumber(Math.abs(b), true)
                             : " + " + formatNumber(Math.abs(b), true);
        steps.push(combinedTerm + " = " + formatNumber(c, true) + signB);
        steps.push(combinedTerm + " = " + formatNumber(cMinusB, true));
        steps.push(formatDivisionStep(variable, cMinusB, sumA, true));
        steps.push(variable + " = " + formatNumber(sol, true));

        return {
          html: eqHtml,
          variable,
          solution: sol,
          stepsHtml: steps.join("<br>"),
          raw: { a1, a2, a3, b, c, sumA, pattern: "hard-multi-like-terms" }
        };

      } else if (pattern === "fraction-decimal") {
        const n = 10;
        const sol = randomSolutionDecimal(); // positive
        const d = randomChoice([0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.2, 1.5, 2.7]);
        let leftMinus = Math.random() < 0.5;
        const fracValue = sol / n; // positive

        if (leftMinus) {
          const c = fracValue - d;
          if (Math.abs(c) > 200) return generateHardQuestion();
          const cNice = Math.round(c * 10) / 10;
          const frac = wrapWithFractionHTML(variable, n.toString());
          const leftExpr = frac + " - " + formatNumber(d, true);
          const rightExpr = formatNumber(cNice, true);
          const eqHtml = leftExpr + " = " + rightExpr;

          const steps = [];
          steps.push(eqHtml);
          const rightPlus = cNice + d; // = fracValue > 0
          steps.push(
            wrapWithFractionHTML(variable, n.toString()) +
            " = " + formatNumber(cNice, true) + " + " + formatNumber(d, true)
          );
          steps.push(
            wrapWithFractionHTML(variable, n.toString()) +
            " = " + formatNumber(rightPlus, true)
          );
          const vVal = rightPlus * n; // positive
          const solRounded = Math.round(vVal * 10) / 10;
          steps.push(formatMultiplicationStep(variable, rightPlus, n, true));
          steps.push(variable + " = " + formatNumber(solRounded, true));

          return {
            html: eqHtml,
            variable,
            solution: solRounded,
            stepsHtml: steps.join("<br>"),
            raw: { n, d, cNice, pattern: "hard-fraction-decimal-minus" }
          };
        } else {
          const c = fracValue + d;
          if (Math.abs(c) > 200) return generateHardQuestion();
          const cNice = Math.round(c * 10) / 10;
          const frac = wrapWithFractionHTML(variable, n.toString());
          const leftExpr = frac + " + " + formatNumber(d, true);
          const rightExpr = formatNumber(cNice, true);
          const eqHtml = leftExpr + " = " + rightExpr;

          const steps = [];
          steps.push(eqHtml);
          const rightMinus = cNice - d; // = fracValue > 0
          steps.push(
            wrapWithFractionHTML(variable, n.toString()) +
            " = " + formatNumber(cNice, true) + " - " + formatNumber(d, true)
          );
          steps.push(
            wrapWithFractionHTML(variable, n.toString()) +
            " = " + formatNumber(rightMinus, true)
          );
          const vVal = rightMinus * n; // positive
          const solRounded = Math.round(vVal * 10) / 10;
          steps.push(formatMultiplicationStep(variable, rightMinus, n, true));
          steps.push(variable + " = " + formatNumber(solRounded, true));

          return {
            html: eqHtml,
            variable,
            solution: solRounded,
            stepsHtml: steps.join("<br>"),
            raw: { n, d, cNice, pattern: "hard-fraction-decimal-plus" }
          };
        }

      } else {
        const kVal = randomChoice([0.02, 0.03, 0.04, 0.05]); // positive
        const sol = randomSolutionInteger(); // positive
        const constPart = randomChoice([0.4, 0.6, 0.8, 1.0]); // positive
        let leftVal = constPart + kVal * sol; // positive
        leftVal = Math.round(leftVal * 10) / 10;
        if (Math.abs(leftVal) > 200) return generateHardQuestion();

        const leftFirst = Math.random() < 0.5;
        const leftExpr = formatNumber(leftVal, true);
        const rightExpr = formatNumber(constPart, true) + " + " + formatNumber(kVal, true) + formatVariable(variable);

        const eqHtml = leftFirst
          ? leftExpr + " = " + rightExpr
          : rightExpr + " = " + leftExpr;

        const steps = [];
        steps.push(eqHtml);

        const step1 =
          leftExpr + " - " + formatNumber(constPart, true) + " = " + formatNumber(kVal, true) + formatVariable(variable);

        const diff = leftVal - constPart;          // = kVal * sol > 0
        const diffNice = Math.round(diff * 10) / 10;

        steps.push(step1);
        steps.push(formatNumber(diffNice, true) + " = " + formatNumber(kVal, true) + formatVariable(variable));
        steps.push(formatDivisionStep(variable, diffNice, kVal, true));
        steps.push(variable + " = " + formatNumber(sol, true));

        return {
          html: eqHtml,
          variable,
          solution: sol,
          stepsHtml: steps.join("<br>"),
          raw: { kVal, constPart, leftVal, pattern: "hard-decimal-coeff" }
        };
      }
    }

    // ----------- Game state & DOM refs -----------

    let currentDifficulty = "easy";
    let currentMode = "game";
    let currentQuestion = null;
    let attempted = 0;
    let correct = 0;
    let score = 0;
    let streak = 0;
    let bestStreak = 0;
    let incorrectQuestions = [];

    let timerEnabled = false;
    let timerDuration = 30;
    let timerRemaining = 0;
    let timerInterval = null;

    const equationDisplayEl = document.getElementById("equation-display");
    const answerInput = document.getElementById("answer-input");
    const submitBtn = document.getElementById("submit-btn");
    const nextBtn = document.getElementById("next-btn");
    const feedbackEl = document.getElementById("feedback");
    const stepsEl = document.getElementById("steps");
    const stepsContentEl = document.getElementById("steps-content");
    const showStepsBtn = document.getElementById("show-steps-btn");
    const answerLabel = document.getElementById("answer-label");

    const statAttempted = document.getElementById("stat-attempted");
    const statCorrect = document.getElementById("stat-correct");
    const statAccuracy = document.getElementById("stat-accuracy");
    const statScore = document.getElementById("stat-score");
    const statStreak = document.getElementById("stat-streak");
    const statBestStreak = document.getElementById("stat-best-streak");
    const incorrectListEl = document.getElementById("incorrect-list");
    const toggleIncorrectBtn = document.getElementById("toggle-incorrect-btn");

    const timerToggle = document.getElementById("timer-toggle");
    const timerSelect = document.getElementById("timer-select");
    const timerDisplay = document.getElementById("timer-display");
    const soundToggle = document.getElementById("sound-toggle");
    const contrastToggle = document.getElementById("contrast-toggle");

    const gameSection = document.getElementById("game-section");
    const worksheetSection = document.getElementById("worksheet-section");

    const wsDiff = document.getElementById("ws-diff");
    const wsCount = document.getElementById("ws-count");
    const wsGenerateBtn = document.getElementById("ws-generate-btn");
    const wsQuestions = document.getElementById("ws-questions");
    const wsAnswers = document.getElementById("ws-answers");
    const wsShowAll = document.getElementById("ws-show-all");
    const wsHideAll = document.getElementById("ws-hide-all");
    const wsKeyStatus = document.getElementById("ws-key-status");

    const devPanel = document.getElementById("dev-panel");
    const devLog = document.getElementById("dev-log");

    // ----------- Mode / difficulty -----------

    document.querySelectorAll(".difficulty-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".difficulty-btn").forEach(b => {
          b.classList.remove("active");
          b.setAttribute("aria-pressed", "false");
        });
        btn.classList.add("active");
        btn.setAttribute("aria-pressed", "true");
        currentDifficulty = btn.dataset.diff;
        if (currentMode === "game") {
          generateNewQuestion();
        }
      });
    });

    document.querySelectorAll(".mode-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".mode-btn").forEach(b => {
          b.classList.remove("active");
          b.setAttribute("aria-pressed", "false");
        });
        btn.classList.add("active");
        btn.setAttribute("aria-pressed", "true");
        currentMode = btn.dataset.mode;
        if (currentMode === "game") {
          gameSection.style.display = "";
          worksheetSection.style.display = "none";
          answerInput.focus();
        } else {
          gameSection.style.display = "none";
          worksheetSection.style.display = "";
        }
      });
    });

    // ----------- Timer -----------

    function updateTimerDisplay() {
      if (!timerEnabled) {
        timerDisplay.textContent = "Timer off";
        return;
      }
      timerDisplay.textContent = timerRemaining + "s";
    }

    function startTimer() {
      if (!timerEnabled) return;
      clearInterval(timerInterval);
      timerRemaining = timerDuration;
      updateTimerDisplay();
      timerInterval = setInterval(() => {
        timerRemaining -= 1;
        if (timerRemaining <= 0) {
          timerRemaining = 0;
          clearInterval(timerInterval);
          updateTimerDisplay();
          timerDisplay.textContent = "Time's up";
        } else {
          updateTimerDisplay();
        }
      }, 1000);
    }

    timerToggle.addEventListener("change", () => {
      timerEnabled = timerToggle.checked;
      if (!timerEnabled) {
        clearInterval(timerInterval);
        timerDisplay.textContent = "Timer off";
      } else {
        timerDuration = parseInt(timerSelect.value, 10);
        startTimer();
      }
    });

    timerSelect.addEventListener("change", () => {
      timerDuration = parseInt(timerSelect.value, 10);
      if (timerEnabled) {
        startTimer();
      }
    });

    soundToggle.addEventListener("change", () => {
      soundEnabled = soundToggle.checked;
    });

    contrastToggle.addEventListener("change", () => {
      if (contrastToggle.checked) {
        document.body.classList.add("high-contrast");
      } else {
        document.body.classList.remove("high-contrast");
      }
    });

    // ----------- Question generation / game -----------

    function generateQuestionByDifficulty(diff) {
      if (diff === "easy") return generateEasyQuestion();
      if (diff === "medium") return generateMediumQuestion();
      if (diff === "hard") return generateHardQuestion();
      const pick = randomChoice(["easy", "medium", "hard"]);
      return generateQuestionByDifficulty(pick);
    }

    function generateNewQuestion() {
      currentQuestion = generateQuestionByDifficulty(currentDifficulty);
      equationDisplayEl.innerHTML = currentQuestion.html;
      answerLabel.textContent = "Solve for " + currentQuestion.variable + ":";
      answerInput.value = "";
      answerInput.disabled = false;
      submitBtn.disabled = false;
      nextBtn.disabled = true;
      feedbackEl.textContent = "";
      feedbackEl.className = "feedback";
      showStepsBtn.disabled = true;
      stepsEl.style.display = "none";
      stepsContentEl.innerHTML = "";
      if (timerEnabled) {
        startTimer();
      }
      answerInput.focus();
    }

    function parseUserAnswer(input) {
      const trimmed = input.replace(/\s+/g, "").replace(",", ".");
      if (trimmed === "") return null;
      const value = parseFloat(trimmed);
      if (!isFinite(value)) return null;
      return value;
    }

    function checkAnswer() {
      if (!currentQuestion) {
        generateNewQuestion();
        return;
      }
      const userValue = parseUserAnswer(answerInput.value);
      if (userValue === null) {
        feedbackEl.textContent = "Please enter a number.";
        feedbackEl.className = "feedback incorrect";
        playBeep(250);
        return;
      }
      const correctValue = currentQuestion.solution;
      const diff = Math.abs(userValue - correctValue);
      attempted += 1;

      if (diff < 1e-3) {
        correct += 1;
        score += 10;
        streak += 1;
        if (streak > 0 && streak % 5 === 0) {
          score += 5;
        }
        if (streak > bestStreak) bestStreak = streak;

        feedbackEl.textContent = "Correct!";
        feedbackEl.className = "feedback correct";
        playBeep(880);
        answerInput.disabled = true;
        submitBtn.disabled = true;
        nextBtn.disabled = false;
        showStepsBtn.disabled = false;
      } else {
        streak = 0;
        feedbackEl.textContent = "Not quite. Try again, or click 'Show steps'.";
        feedbackEl.className = "feedback incorrect";
        playBeep(200);
        showStepsBtn.disabled = false;

        incorrectQuestions.push({
          equationHtml: currentQuestion.html,
          correct: correctValue,
          variable: currentQuestion.variable
        });
      }

      updateStats();
    }

    function updateStats() {
      statAttempted.textContent = attempted;
      statCorrect.textContent = correct;
      const accuracy = attempted === 0 ? 0 : Math.round((correct / attempted) * 100);
      statAccuracy.textContent = accuracy + "%";
      statScore.textContent = score;
      statStreak.textContent = streak;
      statBestStreak.textContent = bestStreak;

      if (incorrectListEl.style.display !== "none") {
        renderIncorrectList();
      }
    }

    function renderIncorrectList() {
      incorrectListEl.innerHTML = "";
      if (incorrectQuestions.length === 0) {
        incorrectListEl.innerHTML = "<div>No incorrect questions yet.</div>";
        return;
      }
      incorrectQuestions.forEach((item, index) => {
        const div = document.createElement("div");
        div.className = "incorrect-item";
        div.innerHTML =
          (index + 1) + ". " +
          item.equationHtml +
          " &nbsp;â‡’&nbsp; " +
          item.variable + " = " + formatNumber(item.correct, true);
        incorrectListEl.appendChild(div);
      });
    }

    submitBtn.addEventListener("click", checkAnswer);
    nextBtn.addEventListener("click", () => {
      generateNewQuestion();
    });

    answerInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        if (!submitBtn.disabled) {
          checkAnswer();
        } else if (!nextBtn.disabled) {
          generateNewQuestion();
        }
      } else if (e.key === "Escape") {
        answerInput.value = "";
      }
    });

    showStepsBtn.addEventListener("click", () => {
      if (!currentQuestion) return;
      stepsContentEl.innerHTML = currentQuestion.stepsHtml;
      stepsEl.style.display = "";
    });

    toggleIncorrectBtn.addEventListener("click", () => {
      if (incorrectListEl.style.display === "none") {
        incorrectListEl.style.display = "";
        toggleIncorrectBtn.textContent = "Hide incorrect questions";
        renderIncorrectList();
      } else {
        incorrectListEl.style.display = "none";
        toggleIncorrectBtn.textContent = "Show incorrect questions";
      }
    });

    // ----------- Worksheet mode -----------

    function generateWorksheet() {
      const count = parseInt(wsCount.value, 10);
      const diff = wsDiff.value;

      wsQuestions.innerHTML = "";
      wsAnswers.innerHTML = "";
      wsKeyStatus.textContent = "Hidden";

      const questions = [];
      for (let i = 0; i < count; i++) {
        questions.push(generateQuestionByDifficulty(diff));
      }

      questions.forEach((q, index) => {
        const qDiv = document.createElement("div");
        qDiv.className = "worksheet-question";
        qDiv.innerHTML = (index + 1) + ". " + q.html;
        wsQuestions.appendChild(qDiv);

        const aDiv = document.createElement("div");
        aDiv.className = "answer-key-item";
        aDiv.dataset.answerIndex = index;
        aDiv.style.display = "none";
        aDiv.innerHTML =
          (index + 1) + ") " +
          q.variable + " = " + formatNumber(q.solution, true);
        wsAnswers.appendChild(aDiv);
      });
    }

    wsGenerateBtn.addEventListener("click", generateWorksheet);

    wsShowAll.addEventListener("click", () => {
      Array.from(wsAnswers.children).forEach(child => {
        child.style.display = "";
      });
      wsKeyStatus.textContent = "Shown";
    });

    wsHideAll.addEventListener("click", () => {
      Array.from(wsAnswers.children).forEach(child => {
        child.style.display = "none";
      });
      wsKeyStatus.textContent = "Hidden";
    });

    // ----------- Dev tools -----------

    function logDev(message) {
      const now = new Date().toISOString().split("T")[1].replace("Z", "");
      devLog.textContent += "[" + now + "] " + message + "\n";
      devLog.scrollTop = devLog.scrollHeight;
    }

    function testGenerateMany(diff, n) {
      let ok = 0;
      let failures = 0;
      for (let i = 0; i < n; i++) {
        try {
          const q = generateQuestionByDifficulty(diff);
          const s = q.solution;
          if (!isFinite(s) || s <= 0) {
            failures++;
            logDev("Invalid or non-positive solution in " + diff + ": " + q.html);
          } else {
            ok++;
          }
        } catch (e) {
          failures++;
          logDev("Error in generation for " + diff + ": " + e.message);
        }
      }
      logDev("Test " + diff + " x" + n + ": OK=" + ok + ", failures=" + failures);
    }

    function testNegativeSolutions() {
      const diffs = ["easy", "medium", "hard"];
      diffs.forEach(diff => {
        let negCount = 0;
        for (let i = 0; i < 50; i++) {
          const q = generateQuestionByDifficulty(diff);
          if (q.solution < 0) negCount++;
        }
        logDev("Negative solutions in " + diff + ": " + negCount + "/50 (should be 0).");
      });
    }

    function testFractionsRendering() {
      const q = generateMediumQuestion();
      if (q.html.indexOf("fraction") !== -1) {
        logDev("Fraction uses HTML fraction markup: " + q.html);
      } else {
        logDev("No fraction found in sample medium question: " + q.html);
      }
    }

    function testDecimalParsing() {
      const sample = "2,5";
      const parsed = parseUserAnswer(sample);
      logDev("Parsing '2,5' => " + parsed);
    }

    function testNoAutoAdvance() {
      logDev("Manual test: Solve a question correctly and verify that Next button must be used.");
    }

    function testStreakScore() {
      attempted = 0;
      correct = 0;
      score = 0;
      streak = 0;
      bestStreak = 0;
      updateStats();

      for (let i = 0; i < 5; i++) {
        attempted++;
        correct++;
        score += 10;
        streak++;
        if (streak > 0 && streak % 5 === 0) score += 5;
        if (streak > bestStreak) bestStreak = streak;
      }
      updateStats();
      logDev("After 5 correct in a row: score=" + score + ", streak=" + streak + ", bestStreak=" + bestStreak + " (expect 55).");
    }

    function testWorksheetMapping() {
      wsDiff.value = "easy";
      wsCount.value = "5";
      generateWorksheet();
      const qCount = wsQuestions.children.length;
      const aCount = wsAnswers.children.length;
      logDev("Worksheet mapping: questions=" + qCount + ", answers=" + aCount + " (should match).");
    }

    function testRandomMix() {
      const counts = { easy: 0, medium: 0, hard: 0 };
      for (let i = 0; i < 60; i++) {
        const q = generateQuestionByDifficulty("random");
        if (!q.raw || !q.raw.pattern) continue;
        const p = q.raw.pattern;
        if (p.indexOf("easy") === 0) counts.easy++;
        else if (p.indexOf("medium") === 0) counts.medium++;
        else if (p.indexOf("hard") === 0) counts.hard++;
      }
      logDev("Random mix (approx): " + JSON.stringify(counts));
    }

    devPanel.addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-dev-test]");
      if (!btn) return;
      const testName = btn.dataset.devTest;
      if (testName === "easy100") testGenerateMany("easy", 100);
      if (testName === "medium100") testGenerateMany("medium", 100);
      if (testName === "hard100") testGenerateMany("hard", 100);
      if (testName === "negatives") testNegativeSolutions();
      if (testName === "fractions") testFractionsRendering();
      if (testName === "decimals") testDecimalParsing();
      if (testName === "no-auto-advance") testNoAutoAdvance();
      if (testName === "streak") testStreakScore();
      if (testName === "worksheet") testWorksheetMapping();
      if (testName === "random-mix") testRandomMix();
    });

    // ----------- Dev mode -----------

    function initDevMode() {
      const params = new URLSearchParams(window.location.search);
      if (params.get("dev") === "1") {
        devPanel.classList.add("visible");
        logDev("Developer mode enabled.");
      }
    }

    // ----------- Init -----------

    function init() {
      soundEnabled = soundToggle.checked;
      timerEnabled = timerToggle.checked;
      timerDuration = parseInt(timerSelect.value, 10);
      generateNewQuestion();
      initDevMode();
    }

    window.addEventListener("load", init);
  </script>
</body>
</html>
